# Add allocations for HSWT

## The problem we're trying to solve

The Data and Insights team have provided a list of 360 allocations which need to be added to the system.

## Justification for doing a manual update

As there are a large number of allocations to be added, it's not
feasible to add them through the frontend.

## The plan

1. Create a temporary table for the allocations import
2. Import the allocation into the temporary table from the CSV in the S3 bucket to check the data is okay
3. Make a backup of the `dbo.SCCV_ALLOCATIONS_COMBINED` table
4. Import the allocations directly from the CSV

## Link to Jira ticket

https://hackney.atlassian.net/browse/SCT-379

## SQL statement(s)

```sql
SELECT aws_commons.create_s3_uri('<S3_BUCKET_NAME>','Adults_HSWT.csv','eu-west-2') AS s3_uri_Adults_HSWT_allocation_import \gset

-- Create temporary allocations import table
CREATE TABLE dbo.SCCV_ALLOCATIONS_COMBINED_IMPORT (
  ID bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL CONSTRAINT XPKDM_SCCV_ALLOCATIONS_COMBINED_IMPORT PRIMARY KEY,
  MOSAIC_ID bigint NOT NULL,
  WORKER_ID bigint,
  ALLOCATION_START_DATE timestamp,
  ALLOCATION_END_DATE timestamp,
  CASE_STATUS varchar(200),
  CLOSURE_DATE_IF_CLOSED timestamp
);

ALTER TABLE dbo.SCCV_ALLOCATIONS_COMBINED_IMPORT
  ADD COLUMN TEAM_ID bigint;
ALTER TABLE dbo.SCCV_ALLOCATIONS_COMBINED_IMPORT
  ADD COLUMN SCCV_CREATED_AT timestamp;
ALTER TABLE dbo.SCCV_ALLOCATIONS_COMBINED_IMPORT
  ADD COLUMN SCCV_CREATED_BY varchar(300);
ALTER TABLE dbo.SCCV_ALLOCATIONS_COMBINED_IMPORT
  ADD COLUMN SCCV_LAST_MODIFIED_AT timestamp;
ALTER TABLE dbo.SCCV_ALLOCATIONS_COMBINED_IMPORT
  ADD COLUMN SCCV_LAST_MODIFIED_BY varchar(300);

-- Import data into temporary table
SELECT aws_s3.table_import_from_s3('dbo.SCCV_ALLOCATIONS_COMBINED_IMPORT','','(format csv, HEADER)',:'s3_uri_Adults_HSWT_allocation_import');

-- Make a backup of allocations table
CREATE TABLE dbo.SCCV_ALLOCATIONS_COMBINED_YYYYMMDD as table dbo.SCCV_ALLOCATIONS_COMBINED;

-- Add allocations from CSV files into the allocation table
SELECT aws_s3.table_import_from_s3('dbo.SCCV_ALLOCATIONS_COMBINED','','(format csv, HEADER)',:'s3_uri_Adults_HSWT_allocation_import');

-- Drop the temporary table
DROP TABLE dbo.SCCV_ALLOCATIONS_COMBINED_IMPORT;
```

## Useful resources

N/A
