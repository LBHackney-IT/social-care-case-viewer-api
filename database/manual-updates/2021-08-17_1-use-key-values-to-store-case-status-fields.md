# Use key values to store case status fields

## The problem we're trying to solve

Alter the tables currently used to store case status types to make them more generic and suitable
for storing other fields associated with case statuses.

## Justification for doing a manual update

We don't have database migrations set up for the API.

## The plan

1. Run SQL statements to create the tables, and migrate subtypes in Staging
2. Run SQL statements to create the tables, and migrate subtypes in Production

## Link to Jira ticket

https://hackney.atlassian.net/browse/SCT-1089

## SQL statement(s)

```sql
CREATE TABLE IF NOT EXISTS dbo.sccv_case_status_field
(
    id                     bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL PRIMARY KEY,
    fk_case_status_type_id bigint,
    name                   varchar(256),
    description            varchar(256),
    CONSTRAINT fk_case_status
        FOREIGN KEY (fk_case_status_type_id)
            REFERENCES dbo.sccv_case_status_type (id)
);

INSERT INTO dbo.sccv_case_status_field(fk_case_status_type_id, name, description)
VALUES ((select id from dbo.sccv_case_status_type where name ilike 'CIN'), 'placementReason',
        'What is the latest primary reason for placement? (Primary need code)');

CREATE TABLE IF NOT EXISTS dbo.sccv_case_status_field_option
(
    id                           bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL PRIMARY KEY,
    fk_sccv_case_status_field_id bigint,
    name                         varchar(256),
    description                  varchar(256),
    CONSTRAINT fk_case_status_field
        FOREIGN KEY (fk_sccv_case_status_field_id)
            REFERENCES dbo.sccv_case_status_field (id)
);

INSERT INTO dbo.sccv_case_status_field_option(fk_sccv_case_status_field_id, name, description)
VALUES
    ((select id from dbo.sccv_case_status_field where name ilike 'subtype'), 'N1', 'Abuse or neglect'),
    ((select id from dbo.sccv_case_status_field where name ilike 'subtype'), 'N2', 'Childâ€™s disability'),
    ((select id from dbo.sccv_case_status_field where name ilike 'subtype'), 'N3', 'Parental disability or illness'),
    ((select id from dbo.sccv_case_status_field where name ilike 'subtype'), 'N4', 'Family in acute stress'),
    ((select id from dbo.sccv_case_status_field where name ilike 'subtype'), 'N5', 'Family dysfunction'),
    ((select id from dbo.sccv_case_status_field where name ilike 'subtype'), 'N6', 'Socially unacceptable behaviour'),
    ((select id from dbo.sccv_case_status_field where name ilike 'subtype'), 'N7', 'Low income'),
    ((select id from dbo.sccv_case_status_field where name ilike 'subtype'), 'N8', 'Absent parenting'),
    ((select id from dbo.sccv_case_status_field where name ilike 'subtype'), 'N9', 'Cases other than children in need'),
    ((select id from dbo.sccv_case_status_field where name ilike 'subtype'), 'N0', 'Not stated');

CREATE TABLE IF NOT EXISTS dbo.sccv_person_case_status_field_option
(
    fk_person_case_status_id       bigint,
    fk_case_status_field_option_id bigint,
    PRIMARY KEY (fk_person_case_status_id, fk_case_status_field_option_id),
    CONSTRAINT fk_person_case_status
        FOREIGN KEY (fk_person_case_status_id)
            REFERENCES dbo.sccv_person_case_status (id),
    CONSTRAINT fk_case_status_field_option
        FOREIGN KEY (fk_case_status_field_option_id)
            REFERENCES dbo.sccv_case_status_field_option (id)
);

ALTER TABLE IF EXISTS dbo.sccv_person_case_status
    DROP COLUMN fk_case_status_subtype_id;

DROP TABLE IF EXISTS dbo.sccv_case_status_subtype;

ALTER TABLE IF EXISTS dbo.sccv_person_case_status
    ADD CONSTRAINT fk_person
        FOREIGN KEY (fk_person_id)
            REFERENCES dbo.dm_persons (person_id);

ALTER TABLE IF EXISTS dbo.sccv_person_case_status
    ADD CONSTRAINT fk_case_status_type
        FOREIGN KEY (fk_case_status_type_id)
            REFERENCES dbo.sccv_case_status_type (id);
```

## Useful resources

None
